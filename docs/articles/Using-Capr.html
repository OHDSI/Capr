<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Capr • Capr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Capr">
<meta property="og:description" content="Capr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Capr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Capr-conceptSets.html">Working with Concept Sets in Capr</a>
    </li>
    <li>
      <a href="../articles/capr_design.html">Capr Design Guide and Roadmap</a>
    </li>
    <li>
      <a href="../articles/capr_objects.html">Capr Objects</a>
    </li>
    <li>
      <a href="../articles/capr_templates.html">Capr for Templating Cohort Definitions</a>
    </li>
    <li>
      <a href="../articles/Examples.html">Cohort Definition Examples</a>
    </li>
    <li>
      <a href="../articles/Using-Capr.html">Using Capr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/Capr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Capr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Capr/blob/HEAD/vignettes/Using-Capr.Rmd" class="external-link"><code>vignettes/Using-Capr.Rmd</code></a></small>
      <div class="hidden name"><code>Using-Capr.Rmd</code></div>

    </div>

    
    
<p>Capr provides R users with a language for building computable cohort
definitions; i.e. definitions that can be translated to SQL code and
executed on a observational health database in the OMOP Common Data
Model format.</p>
<p>While some familiarity with the OMOP Common Data Model standard and
the Observational Health Data Science and Informatics (OHDSI) open
source ecosystem is recommended, this tutorial assumes very little prior
knowledge.</p>
<p>We define a “cohort” as a set of persons who meet a set of inclusion
criteria for a duration of time. A cohort can be thought of a set of
person-time, the time during which persons in a database met the cohort
definition.</p>
<p>A cohort is built by identifying a set of potential index dates and
then applying inclusion criteria to those potential index dates. Finally
persons exit a cohort either at an explicitly specified time (e.g. X
days after index) or when they are no longer under observation.</p>
<p>In the OMOP CDM data elements are standardized so every OMOP CDM
database uses the same codes to represent identical clinical data
elements. Codes can be looked up in a publicly available vocabulary
search tool called <a href="https://athena.ohdsi.org/" class="external-link">Athena.</a></p>
<p>Let’s jump into some simple cohort definitions with Capr. We can use
an example database called <code>Eunomia</code> to create reproducible
code examples.</p>
<div class="section level2">
<h2 id="building-a-concept-set">Building a concept set<a class="anchor" aria-label="anchor" href="#building-a-concept-set"></a>
</h2>
<p>The condition concept ID for Gastrointestinal hemorrhage is 192671.
We can create a concept set with the <code>cs</code> function which
works similar to the <code>c</code> function for creating vectors in
R.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/Capr/" class="external-link">Capr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">GIBleed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">192671</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"GIbleed"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">GIBleed</span></span></code></pre></div>
<p>The GIBleed concept set will include all descendants of the
Gastrointestinal hemorrhage concept 192671.</p>
</div>
<div class="section level2">
<h2 id="creating-a-cohort">Creating a cohort<a class="anchor" aria-label="anchor" href="#creating-a-cohort"></a>
</h2>
<p>Creating a simple cohort with the index date at the first occurrence
of a GI bleed condition occurrence is done in a single line of R code.
This cohort takes advantage of many defaults that match the defaults in
Atlas.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">giBleedCohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="../reference/entry.html">entry</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">GIBleed</span><span class="op">)</span>,</span>
<span>    observationWindow <span class="op">=</span> <span class="fu"><a href="../reference/continuousObservation.html">continuousObservation</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="fl">0L</span><span class="op">)</span>,</span>
<span>    primaryCriteriaLimit <span class="op">=</span> <span class="st">"First"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exit <span class="op">=</span> <span class="fu"><a href="../reference/exit.html">exit</a></span><span class="op">(</span></span>
<span>    endStrategy <span class="op">=</span> <span class="fu"><a href="../reference/observationExit.html">observationExit</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">giBleedCohort</span></span></code></pre></div>
<p>Cohort definitions may get more complex than this example. In general
there are four slots that need to be filled for a Capr cohort: first,
entry which defines the index event; second, attrition which defines the
persons that are withdrawn from the cohort given inclusion or exclusion
criteria; third, exit which defines when the person leaves the cohort
and is no longer observation; and fourth, the era which defines the span
of time of which successive periods are combined into one as well as the
truncation of the patient timeline. Capr allows you to define different
permutations of this cohort structure given the clinical idea under
analysis for the study.</p>
</div>
<div class="section level2">
<h2 id="generating-a-cohort">Generating a cohort<a class="anchor" aria-label="anchor" href="#generating-a-cohort"></a>
</h2>
<p>Capr is only responsible for the definition of the cohort. Capr ends
when it creates a Capr Cohort object or coerces it into a json
structure. At this point, if we want to generate the cohort we would
switch over to different HADES software, in particular <a href="https://github.com/OHDSI/CirceR" class="external-link">CirceR</a> and <a href="https://github.com/OHDSI/CohortGenerator" class="external-link">CohortGenerator</a>.
These two R packages will help convert the json definition into
executable SQL to run on your database. A generated cohort in a table
will have an nx4 structure with the following columns:
<em>cohort_definition_id, subject_id, cohort_start_date,
cohort_end_date</em>. This table is what is used to do subsequent
portions of an OHDSI study. Below is an example of how we can take the
cohort from Capr and generate it on our database. For more information
on generation, follow the examples from <a href="https://github.com/OHDSI/CohortGenerator" class="external-link">CohortGenerator</a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">giBleedCohortJson</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.json.html">as.json</a></span><span class="op">(</span><span class="va">giBleedCohort</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/buildCohortQuery.html" class="external-link">buildCohortQuery</a></span><span class="op">(</span></span>
<span>  expression <span class="op">=</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/cohortExpressionFromJson.html" class="external-link">cohortExpressionFromJson</a></span><span class="op">(</span><span class="va">giBleedCohortJson</span><span class="op">)</span>,</span>
<span>  options <span class="op">=</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/createGenerateOptions.html" class="external-link">createGenerateOptions</a></span><span class="op">(</span>generateStats <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortsToCreate</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  cohortId <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  cohortName <span class="op">=</span> <span class="st">"GI Bleed"</span>,</span>
<span>  sql <span class="op">=</span> <span class="va">sql</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortTableNames.html" class="external-link">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"my_cohort_table"</span><span class="op">)</span></span>
<span><span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/createCohortTables.html" class="external-link">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Generate the cohorts</span></span>
<span><span class="va">cohortsGenerated</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/generateCohortSet.html" class="external-link">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortsToCreate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the cohort counts</span></span>
<span><span class="va">cohortCounts</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CohortGenerator/reference/getCohortCounts.html" class="external-link">getCohortCounts</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTable <span class="op">=</span> <span class="va">cohortTableNames</span><span class="op">$</span><span class="va">cohortTable</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Lavallee, Adam Black.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
