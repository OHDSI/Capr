<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capr Design Guide and Roadmap • Capr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Capr Design Guide and Roadmap">
<meta property="og:description" content="Capr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Capr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Capr-conceptSets.html">Working with Concept Sets in Capr</a>
    </li>
    <li>
      <a href="../articles/capr_design.html">Capr Design Guide and Roadmap</a>
    </li>
    <li>
      <a href="../articles/capr_objects.html">Capr Objects</a>
    </li>
    <li>
      <a href="../articles/capr_templates.html">Capr for Templating Cohort Definitions</a>
    </li>
    <li>
      <a href="../articles/Examples.html">Cohort Definition Examples</a>
    </li>
    <li>
      <a href="../articles/Using-Capr.html">Using Capr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/Capr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Capr Design Guide and Roadmap</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Capr/blob/HEAD/vignettes/capr_design.Rmd" class="external-link"><code>vignettes/capr_design.Rmd</code></a></small>
      <div class="hidden name"><code>capr_design.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ohdsi.github.io/Capr/" class="external-link">Capr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a>
</h2>
<p>Capr, pronounced ‘kay-pr’ like the edible flower, is an R package
that serves as a programmatic interface to defining cohort definitions
for data standardized to the OMOP CDM. Capr allows for templating cohort
logic, where a user can shuffle through concept sets to initiate
variations of a cohort definition. Cohort templating is a critical value
add that Capr provides to OHDSI software. The intent of this software is
to make the process of defining cohorts less of a clerical task (via
point and click) and allow for OHDSI studies to be designed in a single
development environment. The value of developing Capr for Odysseus is
that it integrates cohort development into the development pipeline,
enables templating which can be leveraged in a phenotyping
framework.</p>
<p>The mechanics of Capr are based on emulating the representation of a
cohort definition as specified by circe-be. Circe-be is the underlying
mechanism that builds sql based on input specification defined by a json
structure that fills in a java class. Capr can be used now be used
without a connection to a CDM, however the user must have knowledge of
the OMOP CDM providing concept ids as inputs. Capr returns an R object
that can be converted to a json string. Commonly, cohort definitions are
distributed within the OHDSI community as json files, therefore it is a
natural endpoint for Capr, allowing circe to serialize to ohdsiSql. The
functionality of Capr includes: creation of a concept set, specifying
the cohort logic, building a cohort definition and coercing it to a json
representation. Future functionality will provide print and validity
methods for class, importing Capr from json and saving/loading cohort
sub-components to disk. Capr also has room to grow in terms of providing
functionality to describe a cohort definition both by graph and text,
modifying cohort definitions by addition of Capr objects and enumerating
sub-components.</p>
<p>Currently, Capr is preparing for a release of v2.0.0 to the OHDSI
community github as a HADES R package. The release date is anticipated
for early spring 2023. There is a plan to incorporate complimentary
changes to v2.0.0 by late summer 2023 in addition to suggestions based
on user feedback.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="purpose">Purpose<a class="anchor" aria-label="anchor" href="#purpose"></a>
</h3>
<p>Capr is a programmatic interface to defining cohort definition for
the OMOP CDM. Capr builds a representation of a cohort through R that
can be serialized to json. The json structure can be imported into
ATLAS. This structure follows that of circe-be, that object
representation of cohort definitions in OHDSI. A valid circe-be json can
be serialized into ohdsisql, a parameterized version of sql that builds
cohort under the assumptions of the OMOP CDM structure. Capr fills a gap
in OHDSI software in providing a programmatic tool for cohort
construction as an alternative to ATLAS. A programmatic tool enables us
to parameterize definitions. This has a few advantages:</p>
<ol style="list-style-type: decimal">
<li>
<em>reduce clerical error</em> – minimize copy/paste activities in
ATLAS by instead offering a cohort skeleton and iterating across concept
sets.</li>
<li>
<em>Focus on concept set development</em> – our ability to properly
enumerate a cohort of patients ultimately relies on whether the correct
concepts have been identified for a database. Many cohort definition
skeletons are simple where the variation in the definition comes largely
from the concepts. Capr allows us to expediate the definition process
and focus on identifying the rights concepts.</li>
<li>
<em>Provide alternative entry points to OHDSI analysis</em> – ATLAS
installation is not guaranteed in a study site with OMOP data. Further
some researchers do not like to use a GUI like ATLAS and prefer to use a
programming language like R. Capr builds an equivalent cohort definition
to ATLAS meaning there is an alternative entry point to an OHDSI study.
Capr allows a researcher to remain in a single interface to complete
their entire analysis: from cohort definition to diagnostics to
analysis. It is however, suggested the Capr be used in tandem with ATLAS
for clinical review.</li>
</ol>
</div>
<div class="section level3">
<h3 id="user-base">User-base<a class="anchor" aria-label="anchor" href="#user-base"></a>
</h3>
<p>A Capr user is someone who has knowledge of OHDSI and the OMOP CDM
and is comfortable programming in R. Capr is intended to be used by data
scientists to help create a scripted representation of a cohort
definition that has been defined and reviewed by a clinical team.
Defining cohorts is a team effort, however Capr gives programmatically
inclined users a tool to produce cohort definitions for their clinical
team.</p>
</div>
</div>
<div class="section level2">
<h2 id="roadmap">Roadmap<a class="anchor" aria-label="anchor" href="#roadmap"></a>
</h2>
<div class="section level3">
<h3 id="goals">Goals<a class="anchor" aria-label="anchor" href="#goals"></a>
</h3>
<p>The goal of this software is to provide a programmatic alternative to
ATLAS for defining cohort definitions. A programmatic interface provides
many advantages to users trying to handle complex studies. Sub-goals are
listed as follows:</p>
<ul>
<li><p><strong>Templating</strong>: Through a programmatic interface,
users can create cohort templates. Templates are representations of the
cohort logic where the input parameters are concept sets. Templates
serve as a solution for minimizing clerical errors when users are trying
to create several definitions for a study.</p></li>
<li><p><strong>Organization</strong>: An issue when running OHDSI
studies is organization. There are several components that need to be
managed over the course of the study. This becomes even more complicated
when using multiple platforms to achieve an analysis (i.e. ATLAS and R).
A goal of Capr is provide a tool to allow OHDSI studies to be developed
on a single interface.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="development-timelines">Development Timelines<a class="anchor" aria-label="anchor" href="#development-timelines"></a>
</h3>
<div class="section level4">
<h4 id="anticipated-release-cycle">Anticipated release cycle<a class="anchor" aria-label="anchor" href="#anticipated-release-cycle"></a>
</h4>
<p>Capr v2 will be gradually released in order to receive feedback from
the OHDSI community and identify areas of improvement. The official v2
release on HADES is anticipated for early spring. Complementary to this
release will be v2.1 which will contain additions that were not
essential for the 2.0 release. This includes methods for the Capr
objects including validity checks and print statements. We will also add
functionality to import json into R as a Capr object.</p>
<table class="table">
<colgroup>
<col width="13%">
<col width="18%">
<col width="67%">
</colgroup>
<thead><tr class="header">
<th>Release</th>
<th>Date</th>
<th>Notes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>v2 alpha</td>
<td>01/19/23</td>
<td>Proof of concept demo on HADES call</td>
</tr>
<tr class="even">
<td>v2 beta</td>
<td>02/13/23</td>
<td>Soft release to specific developers for feedback</td>
</tr>
<tr class="odd">
<td>v2 HADES</td>
<td>03/15/23</td>
<td>HADES release of v2 on OHDSI github</td>
</tr>
<tr class="even">
<td>v2 CRAN</td>
<td>03/17/23</td>
<td>Submission of Capr to CRAN</td>
</tr>
<tr class="odd">
<td>v2.0.x</td>
<td>04/23 - 7/23</td>
<td>Period of observation, do patches and bug fixes</td>
</tr>
<tr class="even">
<td>v2.1</td>
<td>~08/23</td>
<td>Complimentary functions to v2 (show, import etc)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="feature-proposals">Feature Proposals<a class="anchor" aria-label="anchor" href="#feature-proposals"></a>
</h4>
<p>The following is a list of proposed future features for Capr that
have been discussed during development. They are listed in order of
priority.</p>
<div class="section level5">
<h5 id="previewing-the-cohort-definition">1) Previewing the cohort definition<a class="anchor" aria-label="anchor" href="#previewing-the-cohort-definition"></a>
</h5>
<p>There is a desire to preview a cohort definition both textually and
pictographically to help the user understand the cohort definition in
development. The cohort preview functions will yield: 1) a markdown text
description of the cohort definition (similar to CirceR) and 2) a
diagram of the definition as a png. The preview functions will be
rendered using the proposed signatures: <code>jot</code> for the text
preview and <code>draw</code> for the graphical preview. This feature is
intended to be used for protocol and report development since clients
desire both a text and graphical representation of a cohort definition.
The text preview will use simple markdown and the graphical preview will
use the grid package to build a diagram.</p>
</div>
<div class="section level5">
<h5 id="cohort-algebra">2) Cohort Algebra<a class="anchor" aria-label="anchor" href="#cohort-algebra"></a>
</h5>
<p>Often times, users want to add aspects of two cohort definitions
together. A future feature would be to construct cohort algebra where
the addition of a cohort (or a component) would add the detail into the
cohort definition. For example, if we wanted to add another set of rules
to a cohort this would be expressed as:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newCohort</span> <span class="op">&lt;-</span> <span class="va">cohort</span> <span class="op">+</span> <span class="va">inclusionRule</span></span>
<span><span class="va">cohortAB</span> <span class="op">&lt;-</span> <span class="va">cohortA</span> <span class="op">+</span> <span class="va">cohortB</span></span></code></pre></div>
<p>Line 1 of code snippet 7 demonstrates how one would add the inclusion
rule Capr object to the cohort definition. Line 2 of code snippet 7
demonstrates how a user would add the components of two cohorts together
to build a new cohort. These functions would only impact the primary
criteria, additional criteria and censoring criteria. The end strategy
and cohort eras would be adopted from the left-hand side. The value add
of this feature would be to simplify cohort modification during
development. It has been a common suggested request from other
users.</p>
</div>
<div class="section level5">
<h5 id="enumeration-of-sub-components">3) Enumeration of Sub-components<a class="anchor" aria-label="anchor" href="#enumeration-of-sub-components"></a>
</h5>
<p>When developing a cohort definition, we often need to know how much
information is available in the database before adding it to our
definition. A future feature for Capr would be a series of functions for
each class that would run a query based on the specification on the
class. This would be done through a CDMConnector connection. The
proposed signature would be <code>inquire</code> which would retrieve
the amount available from a component of the cohort definition. We could
also use this as feasibility for building towards a ohdsiSql
serialization directly from the Capr object. This would also provide
feasibility in terms of building cohort attrition as a return of a Capr
object. The value add of this feature would be to help users navigate
the database during cohort construction.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="maintenance-plan">Maintenance Plan<a class="anchor" aria-label="anchor" href="#maintenance-plan"></a>
</h3>
<p>Maintenance of Capr will be done by Martin Lavallee and Adam Black.
We plan to respond to bug fixes and feature requests via github issues.
Between v2.0.0 release and v2.1.0 release, Capr maintenance team will
source feature requests but will delay production implementation until
v2.1 release on the main branch. New features will be add to the develop
branch, which will remain stable, as a experimental release.</p>
</div>
</div>
<div class="section level2">
<h2 id="design">Design<a class="anchor" aria-label="anchor" href="#design"></a>
</h2>
<div class="section level3">
<h3 id="a--orientation">A. Orientation<a class="anchor" aria-label="anchor" href="#a--orientation"></a>
</h3>
<div class="section level4">
<h4 id="i--entry-point">i. Entry Point<a class="anchor" aria-label="anchor" href="#i--entry-point"></a>
</h4>
<p>Ideally, Capr should be used in tandem with a connection to an OMOP
vocabulary. Connection to an OMOP vocabulary can be done through
DatabaseConnector or CDMConnector. This allows users to lookup concepts
before applying them in Capr objects. Capr does not provide
functionality to optimize concept lookup; this is a feature passed to
other OHDSI software. Capr assumes the list of concepts as inputs.</p>
</div>
<div class="section level4">
<h4 id="ii--exit-point">ii. Exit Point<a class="anchor" aria-label="anchor" href="#ii--exit-point"></a>
</h4>
<p>Capr stops upon development of the json structure, which is typically
saved as a file in a directory. The previous version of Capr allowed for
the user to create the ohdsiSql via CirceR. However, this was deemed an
overlap between other OHDSI R packages (CirceR, CohortGenerator etc.)
and it felt more appropriate for the Capr process to end at building the
json file. Ultimately the item that is passed across the OHDSI network
is the cohort definition json. The json file can be upload into ATLAS or
into R where the ohdsiSql can be built using CirceR. Json is a straight
input to build the SQL, so it was deemed the minimally sufficient output
needed. We intend to draw distinct lines between OHDSI software in order
to improve standard workflows, that are either site internal or for
network studies.</p>
</div>
</div>
<div class="section level3">
<h3 id="b--functionality">B. Functionality<a class="anchor" aria-label="anchor" href="#b--functionality"></a>
</h3>
<p>Capr provides the programmatic interface for constructing cohort
definitions that maps to the circe-be logic. In order to maintain this
correspondence, the functionality of Capr covers: building concept sets,
composing and building the cohort definition, and coercing Capr to json.
Future functionality will be added into the section once they are
released.</p>
<div class="section level4">
<h4 id="i--concept-set-builder">i. Concept Set Builder<a class="anchor" aria-label="anchor" href="#i--concept-set-builder"></a>
</h4>
<p>Before defining cohort logic, the user must specify concept sets.
Capr provides functionality to build concept sets off standardized OMOP
concept IDs. How the user finds these IDs is left to other tools. A
concept set is built in Capr as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">201826L</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T2D"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fl">201826L</span>, <span class="fl">201254L</span>, name <span class="op">=</span> <span class="st">"Diabetes"</span><span class="op">)</span></span></code></pre></div>
<p>The first example in code snippet 1 provides the concept set and
specifies that it includes all descendants. Capr supplies a command for
the three types of concept mapping: include descendants, exclude, and
include mapped. The second example in code snippet 1 provides builds a
concept set based on a vector of concept IDs. The first argument of the
cs command is an ellipse capturing a variety of input giving the user
flexibility. The second argument gives the concept set a name, which in
general should be supplied for readability.</p>
<p>When a concept set is created in Capr, it is tagged with a global
unique identifier (GUID) using the R package digest. The purpose of this
is to ensure that the id of concept set is unique to its construction.
In ATLAS, the concept id attached to the concept set is a local id. This
means that the id is an integer starting from 0 that identifies the
concept set in the definition. This creates an issue if we were to
parameterize the concept set, therefore the tag must be unique to the
concept set. Since circe-be uses integers, Capr must resolve this issue
on the backend, something described in the coercion section.</p>
</div>
<div class="section level4">
<h4 id="ii--cohort-builder">ii. Cohort Builder<a class="anchor" aria-label="anchor" href="#ii--cohort-builder"></a>
</h4>
<p>Next, a user must be able to build a cohort definition in R,
therefore Capr provides functionality to define a cohort definition and
sub-components of the cohort definition. Capr provides a constructor for
each circe-be element (i.e. query, count, group, windows). A cohort is
defined using the function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cohort.html">cohort</a></span><span class="op">(</span><span class="va">entry</span>, <span class="va">attrition</span>, <span class="va">exit</span>, <span class="va">era</span><span class="op">)</span></span></code></pre></div>
<p>The inputs for the cohort function are the four components for
defining a cohort: entry which accrues the initial set of patients,
attrition which defines the logic that filters the initial set of
patients based on inclusion and exclusion criteria, exit which
determines how the person exits the cohort and era which defines the
span of time in which events are considered to have a cohort event. Each
of these four elements are constructed based on circe-be subcomponents
including:</p>
<ol style="list-style-type: decimal">
<li>
<em>Query</em>: an object that defines which concepts to extract
from a domain table in the CDM;</li>
<li>
<em>Attribute</em>: an object that specifies a subpopulation of the
query;</li>
<li>
<em>Criteria</em>: an object that temporally enumerates the presence
or absence of an event relative to a point in time; and</li>
<li>
<em>Group</em>: an object that binds multiple criteria and
sub-groups as a single expression.</li>
</ol>
<div class="section level5">
<h5 id="query">1) Query<a class="anchor" aria-label="anchor" href="#query"></a>
</h5>
<p>A query is constructed via the name of the domain table in the OMOP
CDM. For example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visit.html">visit</a></span><span class="op">(</span><span class="va">conceptSet</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu">condition</span><span class="op">(</span><span class="va">concept</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>The conceptSet input takes on a a concept set built from the cs
command. The dots argument is where the user can supply attributes that
contextualize the query to a specific subpopulation.</p>
</div>
<div class="section level5">
<h5 id="attribute">2) Attribute<a class="anchor" aria-label="anchor" href="#attribute"></a>
</h5>
<p>An attribute has its own set of constructor functions that are
variations on four types of attributes that may be used:</p>
<ul>
<li>
<strong>op</strong>: a boolean operator matched with either a
numeric, integer or date value</li>
<li>
<strong>concept</strong>: attributed built on an OMOP concept
id</li>
<li>
<strong>logic</strong> an attribute defined by a <code>T/F</code>
toggle</li>
<li>
<strong>nested</strong>: an attribute based on a Capr group
object</li>
</ul>
<p>An example of using an attribute within a query is shown in code
snippet 4:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">condition</span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">201826L</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T2D"</span><span class="op">)</span>, <span class="fu"><a href="../reference/attributes.html">male</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">condition</span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">201826L</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T2D"</span><span class="op">)</span>, <span class="fu"><a href="../reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="../reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">condition</span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">201826L</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T2D"</span><span class="op">)</span>, <span class="fu">first</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The first example in code snippet 4 utilizes a concept attribute. The
<code><a href="../reference/attributes.html">male()</a></code> function automatically maps the concept to the male
concept id. Other concept attribute functions will have mappers and
helpers to assist the user in selecting the correct concept to add as an
attribute. The second example of an attribute in code snippet 4 is for
an op attribute. Any op attribute begins with the domain (i.e. age,
startDate etc) and then takes an input of an op. An op is a function
with the following signatures:</p>
<table class="table">
<thead><tr class="header">
<th>Operator</th>
<th>Name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>gt</td>
<td>Greater than</td>
</tr>
<tr class="even">
<td>gte</td>
<td>Greater than or equal to</td>
</tr>
<tr class="odd">
<td>lt</td>
<td>Less than</td>
</tr>
<tr class="even">
<td>lte</td>
<td>Less than or equal to</td>
</tr>
<tr class="odd">
<td>eq</td>
<td>Equal to</td>
</tr>
<tr class="even">
<td>bt</td>
<td>Between</td>
</tr>
<tr class="odd">
<td>nbt</td>
<td>Not between</td>
</tr>
</tbody>
</table>
<p>Note that with the bt and nbt functions the input requires two
values, a start and stop, specifying a bounded range of values. The last
example in code snippet 4 is for a logic attribute. The logic attribute
is simple in that if it is added to the query it will toggle TRUE for a
the specification of the domain. In the example we omit one for a nested
attribute because it is more complex and requires explanation of a
criteria and group, which are stated in the upcoming sections. A full
list of available attributes will be included in a future appendix.</p>
</div>
<div class="section level5">
<h5 id="criteria">3) Criteria<a class="anchor" aria-label="anchor" href="#criteria"></a>
</h5>
<p>A criteria is constructed first on an operator that specifies the
number of times the criteria is observed, second the query of which the
criteria is based on and finally an aperture (i.e. a time window)
specifying the timing relative to the index event at which we are to
observe the specified criteria. Code snippet 5 shows an example of a
criteria call:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>        query <span class="op">=</span> <span class="fu">condition</span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">201826L</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T2D"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span><span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span></code></pre></div>
<p>A note for the criteria is that its meaning is tethered to an event
specified in another part of a cohort definition. This means that a
criteria object applies either for cohort attrition (inclusion rules),
additional criteria for the primary criteria or in a nested attribute
where the index event is the query to which the attribute is attached.
The aperture is what restricts the criteria to certain situations. An
aperture is built using the <code>duringInterval</code> command, where
the first option is the start of the window and second is the end of a
window. The temporal deployment of the query makes this object
complex.</p>
</div>
<div class="section level5">
<h5 id="group">4) Group<a class="anchor" aria-label="anchor" href="#group"></a>
</h5>
<p>The final sub-component binds multiple criteria and sub-groups in a
single expression. In Capr, this is done using the term with, to which
we attach the options all, any, at most or at least. This specifies for
the candidate to enter the cohort they have to satisfy the
specifications of the group, whether that is at least 1 criteria or all.
In the example below we assume that the query and aperture have been
specified elsewhere in a script.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/withAny.html">withAny</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, query <span class="op">=</span> <span class="va">abLabHb</span>, aperture <span class="op">=</span> <span class="va">ap1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, query <span class="op">=</span> <span class="va">abLabRan</span>, aperture <span class="op">=</span> <span class="va">ap1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, query <span class="op">=</span> <span class="va">abLabFast</span>, aperture <span class="op">=</span> <span class="va">ap1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In code snippet 6, we start the group by specifying what needs to be
satisfied in order for the candidate to enter the cohort, in this case
they must satisfy all the queries. If the group is based on
<code>atLeast</code> or <code>atMost</code> then we must also specify an
integer stating how many components need to be satisfied. Groups make
complexity possible in a cohort definition where there are multiple
factors that specify qualification of remaining in a cohort. Groups can
also take on subgroups, for example we could say
<code>withAll(withAny(..))</code>. The group is also the basis of the
nested attribute. Specification that a group is for a nested attribute
is as simple as adding <code>nestedWith</code> to the function
signature.</p>
</div>
</div>
<div class="section level4">
<h4 id="iii--coercionmapping">iii. Coercion/Mapping<a class="anchor" aria-label="anchor" href="#iii--coercionmapping"></a>
</h4>
<p>For OHDSI studies, the key representation of a cohort definition from
a software perspective is via a json file. Thus, we need to coerce the
Capr object into a json file so that it can be used within studies or
exchanged with other researchers. Previously we had constructed a cohort
definition via an R representation supported by Capr. Now we must turn
this R object into a json file to save to disk. Coercion is a complex
task because Capr must track two aspects of the definition: 1) the
concept sets indicating the codes to search within the CDM and 2) the
logic specifying how to deploy the codes on the CDM. The following
explains how this process is achieved in an abstract sense.</p>
<p><strong>Step 1: Collect and replace concept identifier</strong></p>
<p>Recall that a concept set is initialized with a GUID from the digest
R package. While this identifier is useful in Capr, in circe the id must
be an integer starting from 0. This ID is an internal reference for the
cohort definition. When coercing the Capr structure to a json we need to
collect all the GUIDs in the definition, remove duplicates and enumerate
each unique concept set for the internal reference. Capr does this in
the background using the internal functions <code>collectGuid</code> and
<code>replaceCodeSetId</code>. The first function builds the unique list
and the second goes into each Capr object and replace the id slot with
the new integer. After this process the object remains a Capr S4 cohort
structure but the ids within each query have changed from GUID
(character) to integer.</p>
<p><strong>Step 2: Coerce concept set from S4 Capr to S4
list</strong></p>
<p>Once the concept sets have been set within the query object, Capr
will then go through the entire definition and extract just the concept
set objects and turn them into an S3 list. The internal function
<code>listConceptSets</code> completes this task, returning a list of
all the concept sets used in the definition and removing duplicates.</p>
<p><strong>Step 3: Coerce cohort logic from S4 Capr to S3
list</strong></p>
<p>The cohort logic is now coerced separately from the concept sets. In
the circe-be json the concept sets are a different slot the remainder of
the definition. Capr handles this the same using the internal
<code>as.list</code> to coerce the Capr S4 object to an S3 list. It
binds the concept set list with the cohort logic list.</p>
<p><strong>Step 4: Convert S3 list to json</strong></p>
<p>Once the object is coerced into an S3 list it can be converted into
json using the <code>jsonlite</code> R package. The function
<code><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">jsonlite::toJSON</a></code> only works on an S3 list. Capr is designed
in S4 because of the complexity of the system, making it easier to
prevent mistakes by the user.</p>
</div>
</div>
<div class="section level3">
<h3 id="object-representation">Object Representation<a class="anchor" aria-label="anchor" href="#object-representation"></a>
</h3>
<p>Capr uses S4 classes in order to define the underpinnings of the
cohort definition. These S4 classes are closely related to the circe-be
java classes that specify the structure of the cohort definition. The
Capr classes assume a few differences in order to allow for
parameterization of the cohort definition via templating and provided
suggested organizational improvements to the structure. The decision to
use S4 classes was made because of the need to have a strict interface
to adhere to the circe-be class. S4 classes are well suited for very
complex codebases, according to Advanced R. Capr’s relation to circe-be
has the sort of complexity, particularly for the coercion aspect of Capr
where the same method is applied slightly differently to each class.
Classes are an important aspect of Capr and S4 provides a good balance
between functional and object-oriented programming.</p>
<!--Add more info on connection to circe--->
</div>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<!--Add Appendicies for classes, attributes, domains--->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Lavallee, Adam Black.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
