<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Capr Objects â€¢ Capr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Capr Objects">
<meta property="og:description" content="Capr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Capr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Capr-conceptSets.html">Working with Concept Sets in Capr</a>
    </li>
    <li>
      <a href="../articles/capr_design.html">Capr Design Guide and Roadmap</a>
    </li>
    <li>
      <a href="../articles/capr_objects.html">Capr Objects</a>
    </li>
    <li>
      <a href="../articles/capr_templates.html">Capr for Templating Cohort Definitions</a>
    </li>
    <li>
      <a href="../articles/Examples.html">Cohort Definition Examples</a>
    </li>
    <li>
      <a href="../articles/Using-Capr.html">Using Capr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
<li>
  <a href="https://github.com/OHDSI/Capr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Capr Objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/Capr/blob/HEAD/vignettes/capr_objects.Rmd" class="external-link"><code>vignettes/capr_objects.Rmd</code></a></small>
      <div class="hidden name"><code>capr_objects.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="intro">Intro<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p><code>Capr</code> allows users to build OHDSI cohort definitions in R
outside of ATLAS. <code>Capr</code>, like ATLAS, uses the same
underlying software <code>circe-be</code> to compose the cohort logic
into an actionable query. Therefore we must understand sub-components of
the cohort definition, in order to properly apply them to our cohort
construction. There are three main sub-components that drive building of
the cohort logic: 1) query, 2) criteria and 3) group. In this vignette,
we will describe the purpose of each sub-component and demonstrate the
<code>Capr</code> commands to invoke these structures.</p>
</div>
<div class="section level2">
<h2 id="query">Query<a class="anchor" aria-label="anchor" href="#query"></a>
</h2>
<div class="section level3">
<h3 id="definition">Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h3>
<p>The <em>query</em> is a <code>circe-be</code> construct that defines
which concepts to extract from which domain table in the OMOP CDM. In
basic terms it is finding the persons that have a particular code in the
data. Through a more technical lens, the query is supplying the
<strong>WHERE</strong> and <strong>FROM</strong> logic in portions of
the SQL script. Ultimately the logic we construct in <code>Capr</code>
or ATLAS render a standardized SQL script that finds persons in the
database, of which the query is vital in providing the code sets to
search from. The <em>query</em> will be found all over the cohort
definition. Whenever we need to apply a concept set, it will be through
a <em>query</em>. In <code>Capr</code> the <em>query</em> function is
specified based on the domain tables available in the CDM. The table
below provides the mapping between the OMOP domain and the the
<code>Capr</code> function call.</p>
<table class="table">
<thead><tr class="header">
<th align="left">OMOP Domain</th>
<th align="left">Capr Function</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">DrugExposure</td>
<td align="left">drugExposure</td>
</tr>
<tr class="even">
<td align="left">DrugEra</td>
<td align="left">drugEra</td>
</tr>
<tr class="odd">
<td align="left">ConditionOccurrence</td>
<td align="left">conditionOccurrence</td>
</tr>
<tr class="even">
<td align="left">ConditionEra</td>
<td align="left">conditionEra</td>
</tr>
<tr class="odd">
<td align="left">ProcedureOccurrence</td>
<td align="left">procedure</td>
</tr>
<tr class="even">
<td align="left">Measurement</td>
<td align="left">measurement</td>
</tr>
<tr class="odd">
<td align="left">VisitOccurrence</td>
<td align="left">visit</td>
</tr>
<tr class="even">
<td align="left">Observation</td>
<td align="left">observation</td>
</tr>
<tr class="odd">
<td align="left">Death</td>
<td align="left">death</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>A simple example of how to use a query in <code>Capr</code> can be
seen below:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1dConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">195771</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T1D"</span><span class="op">)</span></span>
<span><span class="va">t1dQuery</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span><span class="op">)</span></span></code></pre></div>
<p>With our query we can apply this in a variety of places within the
cohort definition. Below we give an example of a cohort of persons
starting on metformin as our index event, where they could not have been
diagnosed with Type 1 Diabetes any time prior.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metforminConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1503297</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"metformin"</span><span class="op">)</span></span>
<span><span class="va">t1dConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">195771</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T1D"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metforminCohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="../reference/entry.html">entry</a></span><span class="op">(</span></span>
<span>    <span class="co"># metformin drug query as index event</span></span>
<span>    <span class="fu"><a href="../reference/drugExposure.html">drugExposure</a></span><span class="op">(</span><span class="va">metforminConceptSet</span>, <span class="fu"><a href="../reference/firstOccurrence.html">firstOccurrence</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    observationWindow <span class="op">=</span> <span class="fu"><a href="../reference/continuousObservation.html">continuousObservation</a></span><span class="op">(</span>priorDays <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, postDays <span class="op">=</span> <span class="fl">365L</span><span class="op">)</span>,</span>
<span>    primaryCriteriaLimit <span class="op">=</span> <span class="st">"All"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  attrition <span class="op">=</span> <span class="fu"><a href="../reference/attrition.html">attrition</a></span><span class="op">(</span></span>
<span>    <span class="st">'noT1d'</span> <span class="op">=</span> <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="fl">0</span>, </span>
<span>        <span class="co"># query for t1d occurrence to exclude patients</span></span>
<span>        query <span class="op">=</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span><span class="op">)</span>, </span>
<span>        aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>          startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exit <span class="op">=</span> <span class="fu"><a href="../reference/exit.html">exit</a></span><span class="op">(</span></span>
<span>    endStrategy <span class="op">=</span> <span class="fu"><a href="../reference/observationExit.html">observationExit</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    censor <span class="op">=</span> <span class="fu"><a href="../reference/censoringEvents.html">censoringEvents</a></span><span class="op">(</span></span>
<span>      <span class="co">#exit based on observence of t1d condition</span></span>
<span>      <span class="co"># query for t1d occurrence for censor</span></span>
<span>      <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span><span class="op">)</span> </span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Notice that the <em>query</em> is applied all over this cohort
definition. The metformin query sets the concept set to use as the index
event. The Type 1 Diabetes (T1D) query sets the attrition of the
patients identified at index who should be excluded for having the
condition. The T1D query also sets the exit from cohort. The cohort ends
when the person has no more observation time in the database or they
have been diagnosed with T1D. Remember the <em>query</em> is infusing
the concept sets into the cohort logic based on which domain to search
for codes in person healthcare records.</p>
</div>
<div class="section level3">
<h3 id="attributes">Attributes<a class="anchor" aria-label="anchor" href="#attributes"></a>
</h3>
<p>The <em>query</em> is often contextualized by an attribute. For
example in the cohort above, we are searching for metformin in the drug
exposure table given it has occurred for the first time in the person
history. The attribute is a object that modifies queries by filtering
records based on the presence of another parameter. Attributes can be
based on person information (such as gender, race, or age), time based
(observation at a certain time window), domain based (presence of a code
in a different column of the same domain), or event based (based on the
observation of another event occurring). We will go into more details on
different attributes in a different vignette. In <code>Capr</code> as
many attributes can be attached within the query after providing the
concept set. Example below:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1dConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">195771</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"T1D"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">maleT1D</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span>, <span class="fu"><a href="../reference/attributes.html">male</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">maleT1D18andOlder</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span>, <span class="fu"><a href="../reference/attributes.html">male</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="../reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">maleT1D18andOlderFirstDx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span></span>
<span>  <span class="va">t1dConceptSet</span>, <span class="fu"><a href="../reference/attributes.html">male</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/age.html">age</a></span><span class="op">(</span><span class="fu"><a href="../reference/gte.html">gte</a></span><span class="op">(</span><span class="fl">18</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="../reference/firstOccurrence.html">firstOccurrence</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>One special type of attribute is a nested query. This construct is
more complex and requires understanding of the <em>criteria</em> and
<em>group</em> objects. We will return to this idea later in this
vignette.</p>
</div>
</div>
<div class="section level2">
<h2 id="criteria">Criteria<a class="anchor" aria-label="anchor" href="#criteria"></a>
</h2>
<div class="section level3">
<h3 id="definition-1">Definition<a class="anchor" aria-label="anchor" href="#definition-1"></a>
</h3>
<p>A <em>criteria</em> object is one that enumerates the presence or
absence of an event within a window of observation relative to an index
point. The index point may be the entry event of the cohort definition.
It could also be a prior event if we are building a nested query. The
purpose of this object is to count whether a person has experienced
certain events that would either include or exclude them from the
cohort. Its easiest to show a <em>criteria</em> using a figure. Say
relative from index we want to see two exposures of a drug within 365
days and 30 days before index. Those that fit that criteria remain in
the cohort, those that do not are excluded from the cohort. See the
figure below as an example:</p>
<div class="float">
<img src="images/criteria_example.png" alt="Example of Criteria"><div class="figcaption">Example of Criteria</div>
</div>
<p>When building a <em>criteria</em> object the user needs: 1) a query,
2) an operator that specifies the number of times a query is observed
(occurrences), and 3) a time window which we call the aperture. Using
the figure as an example, think of the stars as the query, the number of
stars as the occurrences, and the box as the aperture. We could orient
this idea around the index event in a variety of different ways.</p>
</div>
<div class="section level3">
<h3 id="example-1">Example<a class="anchor" aria-label="anchor" href="#example-1"></a>
</h3>
<p>With this definition in mind, let us build an example of a
<em>criteria</em> object that reflects the image above.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">atenololConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1314002</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"atenolol"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atenololCriteria</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">2</span>, </span>
<span>  query <span class="op">=</span> <span class="fu"><a href="../reference/drugExposure.html">drugExposure</a></span><span class="op">(</span><span class="va">atenololConceptSet</span><span class="op">)</span>,</span>
<span>  aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>    startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This <em>criteria</em> specifies that we must observe at least 2 drug
exposures of atenolol within 365 days and 30 days before the index start
date. By itself, a <em>criteria</em> makes little sense. It must sit
within the context of the entire cohort definition, where an index event
has been specified. In <code>Capr</code> the <em>criteria</em> object is
called in three ways: <code>atLeast</code>, <code>atMost</code> and
<code>exactly</code>. The <em>criteria</em> object in <code>Capr</code>
is contextualized by the number of occurrences of the query for its
function call. If we wanted to have exactly 2 drug exposures of atenolol
or at most 2 drug exposures they can be done as shown below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">atenololConceptSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">1314002</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"atenolol"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">atenololCriteriaA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">2</span>, </span>
<span>  query <span class="op">=</span> <span class="fu"><a href="../reference/drugExposure.html">drugExposure</a></span><span class="op">(</span><span class="va">atenololConceptSet</span><span class="op">)</span>,</span>
<span>  aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>    startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">atenololCriteriaB</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/atMost.html">atMost</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">2</span>, </span>
<span>  query <span class="op">=</span> <span class="fu"><a href="../reference/drugExposure.html">drugExposure</a></span><span class="op">(</span><span class="va">atenololConceptSet</span><span class="op">)</span>,</span>
<span>  aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>    startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aperture">Aperture<a class="anchor" aria-label="anchor" href="#aperture"></a>
</h3>
<p>An important part of the <em>criteria</em> object is providing the
temporal context to enumerating the occurrences of the query. In
<code>Capr</code> we term this interval relative to index as the
aperture. It is the opening in the patient timeline at which we are
enumerating the event of interest. An aperture can view when an event
starts and when the event ends. For both event start and event end, we
define a window for which the event is observed. Below we illustrate a
few examples of building an aperture and then show the corresponding the
<code>Capr</code> code.</p>
<p><img src="images/aperture1.png" alt="Example 1: Retrospective Start Window"> In this first example we
are observing when an event starts between time of 365 to 30 days before
the index start date. To build this aperture we use the following
<code>Capr</code> code:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aperture1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>  startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Notice that we define the anchor for our index, either the index
start date or the index end date. More times than not this will be the
index start date.</p>
<p><img src="images/aperture2.png" alt="Example 2: Retrospective Start Window all time prior"> This next
example is similar to the first, however now we have an unbounded event
window. In this case the event start must be between any time before and
30 days before the index start date. In <code>Capr</code> we can always
create an unbounded event window by using the <code>Inf</code> operator
in our code, as shown below.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aperture2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>  startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="images/aperture3.png" alt="Example 3: Start window including future time"> Our next example
provides an instance where we want our event window to utilize future
time. Normally we want to observe an event prior to index. On occasion
we can allow for an event to take place after index. The
<code>Capr</code> code to build this aperture is shown below:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aperture3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>  startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, b <span class="op">=</span> <span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="images/aperture4.png" alt="Example 4: Start and end window in aperture"> Our final example
shows a scenario when we want the aperture to be constrained by both a
start window and end window. The end window is considering observation
of the end of the event. Say for example the event era starts with an
exposure to a drug and end is when the person stops taking the drug. If
the interest is the full time the person was encountering this medical
event we need to create both a start and end window in the aperture. The
<code>Capr</code> code below would replicate the concept from the
figure.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aperture4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>  startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span>,</span>
<span>  endWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventEnds.html">eventEnds</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">30</span>, b <span class="op">=</span> <span class="fl">365</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>An aperture has two more potential toggles: a) restrict event to the
same visit and b) allow events outside the observation period. By
default these options are toggled as <code>FALSE</code>, so they do not
need to be defined in the <code>Capr</code> code unless made
<code>TRUE</code>. These are more advanced options in cohort building.
To use the we add this to aperture example 4 to show a full set of
options for an aperture in <code>Capr</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aperture5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>  startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="fl">365</span>, b <span class="op">=</span> <span class="op">-</span><span class="fl">30</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span>,</span>
<span>  endWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventEnds.html">eventEnds</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">30</span>, b <span class="op">=</span> <span class="fl">365</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span>,</span>
<span>  restrictVisit <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ignoreObservationPeriod <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="group">Group<a class="anchor" aria-label="anchor" href="#group"></a>
</h2>
<div class="section level3">
<h3 id="definition-2">Definition<a class="anchor" aria-label="anchor" href="#definition-2"></a>
</h3>
<p>A <em>group</em> object is one that binds multiple criteria and
sub-groups as a single expression. This is a very powerful construction
because it allows us to build all sorts of complexity in our cohort
definition. A <em>group</em> must have an operator informing how many
<em>criteria</em> must be <code>TRUE</code> in order for the person to
enter the cohort. In <code>Capr</code> the options available to build a
group are: <code>withAll</code>, <code>withAny</code>,
<code>withAtLeast</code> and <code>withAtMost</code>. The functions are
meant to be intuitive in terms of logic building. <code>withAll</code>
indicates all the criteria must be <code>TRUE</code> for the person to
remain in the cohort. <code>withAny</code> indicates any one of the
<em>criteria</em> needs to be <code>TRUE</code>. The functions
<code>withAtLeast</code> and <code>withAtMost</code> require an integer
to determine how many <em>criteria</em> must be <code>TRUE</code>.</p>
</div>
<div class="section level3">
<h3 id="example-2">Example<a class="anchor" aria-label="anchor" href="#example-2"></a>
</h3>
<p>To show the idea of a <em>group</em> let us consider a very
complicated cohort, like the <a href="https://www.phekb.org/phenotype/type-2-diabetes-mellitus" class="external-link">PheKB
T2D case algorithm</a>. To consider a person to be a case of T2D, any
one of 5 pathways needs to be <code>TRUE</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t2dAlgo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/withAny.html">withAny</a></span><span class="op">(</span></span>
<span>  <span class="co"># Path 1: 0 T2Dx + 1 T2Rx + 1 abLab</span></span>
<span>  <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/withAny.html">withAny</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabHb</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabRan</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabFast</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co">#Path 2: 1 T2Dx + 0 T1Rx + 0 T2Rx + 1 AbLab</span></span>
<span>  <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>            <span class="va">t1dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>            <span class="va">t2dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/withAny.html">withAny</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabHb</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabRan</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>              <span class="va">abLabFast</span>, </span>
<span>              <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co">#Path 3: 1 T2Dx + 0 T1Rx + 1 T2Rx</span></span>
<span>  <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>            <span class="va">t1dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co">#Path 4: 1 T2Dx + 1 T1Rx + 1 T1Rx|T2Rx</span></span>
<span>  <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t1dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t1dDrugWT2Drug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co">#Path 5: 1 T2Dx  + 1 T1Rx + 0 T2Rx + 2 T2Dx</span></span>
<span>  <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">t1dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>            <span class="va">t2dDrug</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">2</span>, </span>
<span>            <span class="va">t2d</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Each pathway is complex and require multiple criteria to determine a
T2D case. The <em>group</em> allows us to bundle multiple ideas together
to build one complex expression.</p>
</div>
<div class="section level3">
<h3 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a>
</h3>
<p>Now that we have introduced the <em>criteria</em> and <em>group</em>,
there are a few important comments on how these objects are used within
<code>circe-be</code>.</p>
<p><strong>1) Criteria must be placed within a group</strong></p>
<p>A <em>criteria</em> can not be used on its own, it must be wrapped in
a <em>group</em>. Even if only one <em>criteria</em> is needed, still
wrap it in a <em>group</em>. An example would be:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noT1d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>  <span class="co"># criteria: no t1d prior</span></span>
<span>  <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    query <span class="op">=</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span><span class="op">)</span>, </span>
<span>    aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>      startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># wrap this in a group withAll</span></span></code></pre></div>
<p>Further to this point, a single attrition rule is a <em>group</em>.
The example of <code>noT1d</code> above would be a single rule in the
cohort attrition. This is how we would apply it:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cohort.html">cohort</a></span><span class="op">(</span></span>
<span>  entry <span class="op">=</span> <span class="fu"><a href="../reference/entry.html">entry</a></span><span class="op">(</span></span>
<span>    <span class="co"># index event....</span></span>
<span>  <span class="op">)</span>,</span>
<span>  attrition <span class="op">=</span> <span class="fu"><a href="../reference/attrition.html">attrition</a></span><span class="op">(</span></span>
<span>    <span class="st">'noT1d'</span> <span class="op">=</span> <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="fl">0</span>, </span>
<span>        <span class="co"># query for t1d occurrence to exclude patients</span></span>
<span>        query <span class="op">=</span> <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">t1dConceptSet</span><span class="op">)</span>, </span>
<span>        aperture <span class="op">=</span> <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>          startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span>a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  exit <span class="op">=</span> <span class="fu"><a href="../reference/exit.html">exit</a></span><span class="op">(</span></span>
<span>    <span class="co">#cohort exit....</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>2) Groups may contain groups</strong></p>
<p>A group may contain more groups as part of the same object. We saw
this in the PheKB T2D example where one path required an abnormal lab.
In the definition there are 3 types of abnormal labs: random glucose,
fasting glucose and HbA1c. Any one of these three could be abnormal as
part of path 1 of the case algorithm. To build this we need a group
within a group.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path 1: 0 T2Dx + 1 T2Rx + 1 abLab</span></span>
<span><span class="va">path1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/withAll.html">withAll</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/exactly.html">exactly</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>          <span class="va">t2d</span>, </span>
<span>          <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>          <span class="va">t2dDrug</span>, </span>
<span>          <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/withAny.html">withAny</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">abLabHb</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">abLabRan</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>            <span class="va">abLabFast</span>, </span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span>startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>3) Nested criteria are groups</strong></p>
<p>Previously we mentioned a special kind of attribute called a nested
criteria (also known via ATLAS as a correlated criteria). The idea of a
nested criteria is that the index event is based on a particular concept
set expression as opposed to the entry event of the cohort definition.
For example, we want to build a cohort based on a hospitalization due to
heart failure. In this case a person is counted in the cohort if they
have first an inpatient visit given that a heart failure (HF) diagnosis
has occurred around the time of the inpatient visit. In
<code>Capr</code> a nested attribute uses the same syntax as a
<em>group</em> with a prefix of <code>nested-</code>, as shown in the
example below. The enumeration of the <em>criteria</em> is now indexed
based on the inpatient visit rather than the entry event of the cohort
definition.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ipCse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">9201</span>, <span class="fl">9203</span>, <span class="fl">262</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"visit"</span><span class="op">)</span></span>
<span><span class="va">hf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cs.html">cs</a></span><span class="op">(</span><span class="fu"><a href="../reference/cs.html">descendants</a></span><span class="op">(</span><span class="fl">316139</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"heart failure"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/visit.html">visit</a></span><span class="op">(</span></span>
<span>  <span class="va">ipCse</span>, <span class="co">#index</span></span>
<span>  <span class="co">#nested attribute</span></span>
<span>  <span class="fu"><a href="../reference/nestedWithAll.html">nestedWithAll</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/atLeast.html">atLeast</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>            <span class="fu"><a href="../reference/conditionOccurrence.html">conditionOccurrence</a></span><span class="op">(</span><span class="va">hf</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/duringInterval.html">duringInterval</a></span><span class="op">(</span></span>
<span>              startWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">Inf</span>, index <span class="op">=</span> <span class="st">"startDate"</span><span class="op">)</span>,</span>
<span>              endWindow <span class="op">=</span> <span class="fu"><a href="../reference/eventStarts.html">eventStarts</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0</span>, index <span class="op">=</span> <span class="st">"endDate"</span><span class="op">)</span></span>
<span>            <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="concluding-remarks">Concluding Remarks<a class="anchor" aria-label="anchor" href="#concluding-remarks"></a>
</h2>
<p>For more information on sub-components of a cohort definition via
<code>circe-be</code>, users should watch the <a href="https://www.youtube.com/@chrisknoll2007" class="external-link">videos</a> created by
Chris Knoll outlining these ideas. while these videos utilize ATLAS,
<code>Capr</code> follows the same principles.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Lavallee, Adam Black.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
